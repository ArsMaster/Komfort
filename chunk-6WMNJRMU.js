import{b as f}from"./chunk-YH33CBJX.js";import{a as h}from"./chunk-EW5TGDZL.js";import{L as p,Q as u,a as l,b as n,fa as g,ha as m}from"./chunk-PZHANSDG.js";var S=class d{supabaseService=u(h);storageService=u(f);products=g([],{});storageMode=g("supabase",{});isLoading=g(!1,{});isUploadingImages=g(!1,{});storageKey="komfort_products";constructor(){m(()=>{this.storageMode()==="local"&&this.saveToLocalStorage(this.products())}),this.initialize()}async initialize(){console.log("=== ProductService \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D ===");let t=localStorage.getItem("komfort_storage_mode")||"supabase";this.storageMode.set(t),console.log(`\u0420\u0435\u0436\u0438\u043C \u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F: ${t}`),t==="local"?this.loadFromLocalStorage():await this.loadFromSupabase()}async uploadProductImages(t){this.isUploadingImages.set(!0);try{console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 ${t.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0442\u043E\u0432\u0430\u0440\u0430...`);let s=await this.storageService.uploadMultipleFiles(t,"product-images","products");return console.log("\u2705 \u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B:",s),s}catch(s){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",s),s}finally{this.isUploadingImages.set(!1)}}async deleteProductImages(t){try{console.log(`\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 ${t.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0442\u043E\u0432\u0430\u0440\u0430...`);let s=t.map(e=>this.storageService.extractFilePathFromUrl(e)).filter(e=>e);s.length>0&&(await this.storageService.deleteMultipleFiles(s,"product-images"),console.log("\u2705 \u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u044B"))}catch(s){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",s),s}}cleanImageUrls(t){return!t||!Array.isArray(t)?["/assets/default-product.jpg"]:t.filter(s=>s&&typeof s=="string").map(s=>{let e=s.trim();return e.startsWith("data:image")?"/assets/default-product.jpg":(this.storageService.isSupabaseStorageUrl(e)||e.startsWith("http")||(e.startsWith("{")&&e.endsWith("}")&&(e=e.slice(1,-1).trim()),e.includes("assets//assets/")&&(e=e.replace("assets//assets/","/assets/")),e.startsWith("/assets/")||(e.startsWith("assets/")?e="/"+e:e.startsWith("/")?e="/assets"+e:e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".png")||e.endsWith(".gif")||e.endsWith(".webp")?e="/assets/"+e:e="/assets/default-product.jpg")),e)}).filter(s=>s&&s.trim()!=="")}base64ToFile(t,s){return this.storageService.base64ToFile(t,s)}async loadFromSupabase(){this.isLoading.set(!0);try{console.log("\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0438\u0437 Supabase...");let t=await this.supabaseService.getProducts();if(console.log("\u{1F4E6} RAW \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u0437 Supabase:",t),t.length>0){let s=await Promise.all(t.map(async e=>{let a=this.cleanImageUrls(e.imageUrls||[]);return console.log(`\u{1F504} \u041A\u043E\u043D\u0432\u0435\u0440\u0442\u0430\u0446\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430 "${e.name}":`),console.log("  \u0418\u0441\u0445\u043E\u0434\u043D\u044B\u0435 imageUrls:",e.imageUrls),console.log("  \u041E\u0447\u0438\u0449\u0435\u043D\u043D\u044B\u0435 imageUrls:",a),{id:e.id,name:e.name||"",description:e.description||"",price:e.price||0,categoryId:typeof e.categoryId=="number"?e.categoryId:1,categoryName:e.categoryName||"\u0411\u0435\u0437 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438",imageUrls:a,stock:e.stock||0,features:e.features||[],createdAt:e.createdAt?new Date(e.createdAt):new Date,updatedAt:e.updatedAt?new Date(e.updatedAt):new Date}}));this.products.set(s),console.log("\u2705 \u0422\u043E\u0432\u0430\u0440\u044B \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B \u0438\u0437 Supabase:"),s.forEach((e,a)=>{console.log(`  ${a+1}. ${e.name}:`,e.imageUrls)}),this.saveToLocalStorage(s)}else console.log("\u{1F4ED} \u0412 Supabase \u043D\u0435\u0442 \u0442\u043E\u0432\u0430\u0440\u043E\u0432"),this.products.set(this.getInitialProducts())}catch(t){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437 Supabase:",t),this.loadFromLocalStorage()}finally{this.isLoading.set(!1)}}loadFromLocalStorage(){try{let t=localStorage.getItem(this.storageKey);if(t){let e=JSON.parse(t).map(a=>n(l({},a),{imageUrls:this.cleanImageUrls(a.imageUrls||[]),createdAt:a.createdAt?new Date(a.createdAt):new Date,updatedAt:a.updatedAt?new Date(a.updatedAt):new Date}));this.products.set(e),console.log("\u{1F4E6} \u0422\u043E\u0432\u0430\u0440\u044B \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B \u0438\u0437 localStorage:",e.length)}else console.log("\u{1F4ED} \u041D\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043D\u044B\u0445 \u0442\u043E\u0432\u0430\u0440\u043E\u0432, \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u044E\u0442\u0441\u044F \u043D\u0430\u0447\u0430\u043B\u044C\u043D\u044B\u0435"),this.products.set(this.getInitialProducts())}catch(t){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437 localStorage:",t),this.products.set(this.getInitialProducts())}}saveToLocalStorage(t){try{localStorage.setItem(this.storageKey,JSON.stringify(t)),console.log("\u{1F4BE} \u0422\u043E\u0432\u0430\u0440\u044B \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B \u0432 localStorage (\u043A\u044D\u0448):",t.length)}catch(s){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0432 localStorage:",s)}}getInitialProducts(){return[{id:1,name:'\u0414\u0438\u0432\u0430\u043D "\u041A\u043E\u043C\u0444\u043E\u0440\u0442"',description:"\u0423\u0434\u043E\u0431\u043D\u044B\u0439 \u0434\u0438\u0432\u0430\u043D \u0434\u043B\u044F \u0433\u043E\u0441\u0442\u0438\u043D\u043E\u0439",price:29999,categoryId:1,categoryName:"\u0413\u043E\u0441\u0442\u0438\u043D\u0430\u044F",imageUrls:["/assets/sofa1.jpg"],stock:5,features:["\u0420\u0430\u0441\u043A\u043B\u0430\u0434\u043D\u043E\u0439","\u0422\u043A\u0430\u043D\u044C - \u0432\u0435\u043B\u044E\u0440"],createdAt:new Date,updatedAt:new Date},{id:2,name:'\u041A\u0440\u043E\u0432\u0430\u0442\u044C "\u041E\u0440\u0442\u043E"',description:"\u041E\u0440\u0442\u043E\u043F\u0435\u0434\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u043A\u0440\u043E\u0432\u0430\u0442\u044C",price:45999,categoryId:2,categoryName:"\u0421\u043F\u0430\u043B\u044C\u043D\u044F",imageUrls:["/assets/bed1.jpg"],stock:3,features:["\u041E\u0440\u0442\u043E\u043F\u0435\u0434\u0438\u0447\u0435\u0441\u043A\u043E\u0435 \u043E\u0441\u043D\u043E\u0432\u0430\u043D\u0438\u0435","\u042F\u0449\u0438\u043A\u0438 \u0434\u043B\u044F \u0431\u0435\u043B\u044C\u044F"],createdAt:new Date,updatedAt:new Date}]}getProducts(){return this.products.asReadonly()}getProductsArray(){return this.products()}getProductById(t){return this.products().find(s=>s.id==t)}getProductsByCategoryId(t){return this.products().filter(s=>s.categoryId===t)}getStorageMode(){return this.storageMode()}getIsLoading(){return this.isLoading.asReadonly()}getIsUploadingImages(){return this.isUploadingImages.asReadonly()}async addProduct(t,s){console.log("\u2795 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u043E\u0432\u043E\u0433\u043E \u0442\u043E\u0432\u0430\u0440\u0430 \u0432 \u0440\u0435\u0436\u0438\u043C\u0435:",this.storageMode());let e=[];try{s&&s.length>0?(console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C ${s.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439...`),e=await this.uploadProductImages(s)):e=this.cleanImageUrls(t.imageUrls||[]);let a=n(l({},t),{id:this.generateId(),imageUrls:e,createdAt:new Date,updatedAt:new Date});if(this.storageMode()==="local")return this.products.update(o=>[...o,a]),console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 localStorage:",a.name),a;{let o={name:a.name,description:a.description,price:a.price,categoryId:a.categoryId,categoryName:a.categoryName,imageUrls:a.imageUrls,stock:a.stock,features:a.features},r=await this.supabaseService.addProduct(o);if(r){let i=n(l({},a),{id:r.id});return this.products.update(c=>[...c,i]),console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 Supabase:",i.name),i}else throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432 Supabase")}}catch(a){if(console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430:",a),e.length>0)try{await this.deleteProductImages(e)}catch(o){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043D\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",o)}throw a}}async updateProduct(t,s,e){console.log("\u270F\uFE0F \u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430 ID:",t);let a=s.imageUrls?[...s.imageUrls]:[];try{if(e&&e.length>0){console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C ${e.length} \u043D\u043E\u0432\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439...`);let o=await this.uploadProductImages(e);a=[...a,...o]}if(a.length>0&&(a=this.cleanImageUrls(a)),this.products.update(o=>o.map(r=>r.id==t?n(l(l({},r),s),{imageUrls:a.length>0?a:r.imageUrls,updatedAt:new Date,id:r.id}):r)),this.storageMode()==="supabase"){let o=n(l({},s),{imageUrls:a.length>0?a:s.imageUrls});await this.supabaseService.updateProduct(String(t),o)||console.warn("\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441 Supabase")}console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D")}catch(o){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430:",o),o}}async deleteProduct(t){console.log("\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430 ID:",t);let s=this.getProductById(t);if(s&&this.storageMode()==="supabase"){let e=s.imageUrls.filter(a=>this.storageService.isSupabaseStorageUrl(a));if(e.length>0)try{await this.deleteProductImages(e)}catch(a){console.warn("\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0438\u0437 Storage:",a)}}if(this.products.update(e=>e.filter(a=>a.id!=t)),this.storageMode()==="supabase")try{await this.supabaseService.deleteProduct(String(t))||console.warn("\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u0438\u0437 Supabase")}catch(e){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0438\u0437 Supabase:",e)}console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0435\u043D")}async switchStorageMode(t){t!==this.storageMode()&&(console.log(`\u{1F504} \u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0440\u0435\u0436\u0438\u043C\u0430 \u0441 ${this.storageMode()} \u043D\u0430 ${t}`),this.storageMode.set(t),localStorage.setItem("komfort_storage_mode",t),t==="local"?this.loadFromLocalStorage():await this.loadFromSupabase())}async testSupabase(){try{let t=await this.supabaseService.getProducts();return console.log("\u2705 Supabase \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D! \u0422\u043E\u0432\u0430\u0440\u043E\u0432 \u0432 \u0431\u0430\u0437\u0435:",t.length),!0}catch(t){return console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F \u043A Supabase:",t),!1}}async syncToSupabase(){console.log("\u{1F517} \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445 \u0441 Supabase...");let t=this.products(),s=0;for(let e of t)try{let a=e.imageUrls;a.filter(c=>!this.storageService.isSupabaseStorageUrl(c)&&!c.startsWith("data:image")).length>0&&(console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0434\u043B\u044F ${e.name}...`),a=["/assets/default-product.jpg"]);let r={name:e.name,description:e.description,price:e.price,categoryId:e.categoryId,categoryName:e.categoryName,imageUrls:a,stock:e.stock,features:e.features};await this.supabaseService.addProduct(r)&&(s++,console.log(`\u2705 \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D: ${e.name}`))}catch(a){console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438 ${e.name}:`,a)}console.log(`\u{1F4CA} \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D\u0430: ${s}/${t.length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`)}generateId(){let s=this.products().map(e=>typeof e.id=="number"?e.id:parseInt(e.id)).filter(e=>!isNaN(e));return s.length>0?Math.max(...s)+1:1}clearProducts(){this.products.set([]),localStorage.removeItem(this.storageKey),console.log("\u{1F9F9} \u0412\u0441\u0435 \u0442\u043E\u0432\u0430\u0440\u044B \u043E\u0447\u0438\u0449\u0435\u043D\u044B")}resetToInitial(){this.products.set(this.getInitialProducts()),console.log("\u{1F504} \u0422\u043E\u0432\u0430\u0440\u044B \u0441\u0431\u0440\u043E\u0448\u0435\u043D\u044B \u043A \u043D\u0430\u0447\u0430\u043B\u044C\u043D\u044B\u043C")}async fixAllImageUrls(){console.log("\u{1F9F9} \u041E\u0447\u0438\u0441\u0442\u043A\u0430 \u0432\u0441\u0435\u0445 imageUrls...");let t=this.products().map(s=>n(l({},s),{imageUrls:this.cleanImageUrls(s.imageUrls||[])}));this.products.set(t),console.log("\u2705 \u0412\u0441\u0435 imageUrls \u043E\u0447\u0438\u0449\u0435\u043D\u044B"),this.storageMode()==="supabase"&&await this.syncToSupabase()}async getImageStats(){let t=this.products(),s=0,e=0,a=0,o=0,r=0;return t.forEach(i=>{i.imageUrls?.forEach(c=>{s++,this.storageService.isSupabaseStorageUrl(c)?e++:c.includes("default-product.jpg")?r++:c.startsWith("data:image")?o++:c.startsWith("/assets/")&&a++})}),{totalImages:s,supabaseImages:e,localImages:a,base64Images:o,defaultImages:r}}async migrateAllImagesToSupabase(){console.log("\u{1F69A} \u041C\u0438\u0433\u0440\u0430\u0446\u0438\u044F \u0432\u0441\u0435\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0432 Supabase Storage...");let t=this.products(),s=0;for(let e of t)try{(e.imageUrls?.filter(o=>!this.storageService.isSupabaseStorageUrl(o)&&!o.startsWith("data:image")&&!o.includes("default-product.jpg"))||[]).length>0&&(console.log(`  \u041C\u0438\u0433\u0440\u0430\u0446\u0438\u044F \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0434\u043B\u044F "${e.name}"...`),await this.updateProduct(e.id,{imageUrls:["/assets/default-product.jpg"]}),s++)}catch(a){console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043C\u0438\u0433\u0440\u0430\u0446\u0438\u0438 \u0434\u043B\u044F ${e.name}:`,a)}console.log(`\u2705 \u041C\u0438\u0433\u0440\u0430\u0446\u0438\u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D\u0430: ${s}/${t.length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`)}async fixBrokenProductImages(){console.log("\u{1F527} \u0418\u0441\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u0431\u0438\u0442\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0442\u043E\u0432\u0430\u0440\u043E\u0432...");let t=this.products(),s=0;for(let e of t)try{if(e.imageUrls?.some(o=>o.includes("20101581_1.jpg")&&!o.startsWith("http"))){console.log(`\u{1F504} \u0418\u0441\u043F\u0440\u0430\u0432\u043B\u044F\u0435\u043C \u0442\u043E\u0432\u0430\u0440 "${e.name}"...`);let o=e.imageUrls.filter(r=>!(r.includes("20101581_1.jpg")&&!r.startsWith("http")));o.length===0&&o.push("/assets/default-product.jpg"),this.storageMode()==="supabase"&&await this.supabaseService.updateProduct(String(e.id),{imageUrls:o}),this.products.update(r=>r.map(i=>i.id===e.id?n(l({},i),{imageUrls:o}):i)),s++,console.log(`\u2705 \u0422\u043E\u0432\u0430\u0440 "${e.name}" \u0438\u0441\u043F\u0440\u0430\u0432\u043B\u0435\u043D`)}}catch(a){console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u0441\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430 "${e.name}":`,a)}console.log(`\u2705 \u0418\u0441\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E ${s} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`)}static \u0275fac=function(s){return new(s||d)};static \u0275prov=p({token:d,factory:d.\u0275fac,providedIn:"root"})};export{S as a};
