<div class="admin-container">
  <div class="admin-header">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏</h1>
    <div class="header-actions">
      <button class="btn-add" (click)="showAddForm()">
        + –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
      </button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–¥–∞–ª–µ–Ω–∏—è -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="cancelDelete()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
      <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "{{ productToDelete?.name }}"?</p>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="cancelDelete()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-delete" (click)="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ -->
  <div class="product-form" *ngIf="showForm">
    <h2>{{ editingProduct ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' : '–î–æ–±–∞–≤–∏—Ç—å' }} —Ç–æ–≤–∞—Ä</h2>
    
    <div class="form-row">
      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
        <input 
          type="text" 
          [(ngModel)]="currentProduct.name" 
          placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" 
          required>
      </div>
      
      <div class="form-group">
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
        <select 
          [(ngModel)]="currentProduct.categoryId" 
          required
          (change)="debugCategorySelect($event)">
          <option [value]="undefined" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
          @for (category of categories(); track category.id) {
            <option [value]="category.id">{{ category.title }}</option>
          }
        </select>
      </div>
    </div>
    
    <div class="form-row">
      <div class="form-group">
        <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
        <input 
          type="number" 
          [(ngModel)]="currentProduct.price" 
          min="0" 
          step="0.01"
          placeholder="0">
      </div>
      
      <div class="form-group">
        <label>–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ</label>
        <input 
          type="number" 
          [(ngModel)]="currentProduct.stock" 
          min="0"
          placeholder="0">
      </div>
    </div>
    
    <div class="form-group">
      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <textarea 
        [(ngModel)]="currentProduct.description" 
        rows="3" 
        placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"></textarea>
    </div>
    
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <div class="form-group">
      <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞</label>
      
      <!-- –í—ã–±–æ—Ä —Ñ–∞–π–ª–æ–≤ -->
      <div class="file-upload-section">
        <input 
          type="file" 
          #multipleFileInput
          (change)="onFilesSelected($event)" 
          multiple 
          accept="image/*"
          class="file-input"
          id="fileInput">
        <label for="fileInput" class="btn-file">
          üìÅ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
        </label>
        
        <small>–ú–∞–∫—Å–∏–º—É–º 10 —Ñ–∞–π–ª–æ–≤, –¥–æ 10MB –∫–∞–∂–¥—ã–π</small>
        
        <!-- –ü—Ä–µ–≤—å—é –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ -->
        @if (selectedFiles.length > 0) {
          <div class="selected-files-count">
            –í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: {{ selectedFiles.length }}
          </div>
          
          <div class="selected-files-preview">
            @for (file of selectedFiles; track $index; let i = $index) {
              <div class="file-preview-item">
                <div class="preview-image">
                  <img [src]="getFilePreview(file)" [alt]="file.name">
                </div>
                <div class="file-info-row">
                  <span class="file-name">{{ getShortFileName(file.name, 15) }}</span>
                  <button 
                    type="button" 
                    (click)="removeFile(i)" 
                    class="remove-file">
                    √ó
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
      
      <!-- –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è URL (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –∑–∞–≥—Ä—É–∑–∫–µ) -->
      <div class="url-fallback">
        <label>–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–∞–∂–¥–æ–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
        <textarea 
          [(ngModel)]="imageUrlsText" 
          rows="4"
          placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
      </div>
    </div>
    
    <div class="form-group">
      <label>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–∫–∞–∂–¥–∞—è —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</label>
      <textarea 
        [(ngModel)]="currentProduct.features" 
        rows="3"
        placeholder="–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ 1&#10;–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ 2&#10;–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ 3"></textarea>
    </div>
    
    <div class="form-actions">
      <button 
        (click)="saveProduct()" 
        class="btn-save"
        [disabled]="isUploadingImages() || !currentProduct.name || !currentProduct.categoryId">
        @if (isUploadingImages()) {
          –ó–∞–≥—Ä—É–∑–∫–∞...
        } @else {
          {{ editingProduct ? '–û–±–Ω–æ–≤–∏—Ç—å' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' }}
        }
      </button>
      <button (click)="cancelEdit()" class="btn-cancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ -->
  <div class="modal-overlay" *ngIf="showImageManager" (click)="closeImageManager()">
    <div class="modal" (click)="$event.stopPropagation()">
      <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏: {{ productToManageImages?.name }}</h3>
      
      <div class="form-group">
        <label>–¢–µ–∫—É—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
        @if (uploadedImageUrls.length > 0) {
          <div class="selected-files-preview">
            @for (url of uploadedImageUrls; track $index; let i = $index) {
              <div class="file-preview-item">
                <div class="preview-image">
                  <img [src]="url" [alt]="'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ' + (i + 1)">
                </div>
                <div class="file-info-row">
                  <span class="file-name">{{ getShortFileName(url, 20) }}</span>
                  <button 
                    type="button" 
                    (click)="removeImage(url)" 
                    class="remove-file">
                    √ó
                  </button>
                </div>
              </div>
            }
          </div>
        } @else {
          <p>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
        }
        
        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="file-upload-section">
          <input 
            type="file" 
            #imageManagerFileInput
            (change)="onFilesSelected($event)" 
            multiple 
            accept="image/*"
            class="file-input"
            id="imageManagerInput">
          <label for="imageManagerInput" class="btn-file">
            üìÅ –î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          </label>
        </div>
        
        <!-- URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
        <div class="url-fallback">
          <label>URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∫–∞–∂–¥–æ–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏):</label>
          <textarea 
            [(ngModel)]="imageUrlsText" 
            rows="4"
            (input)="updateImageUrlsFromText()"></textarea>
        </div>
      </div>
      
      <div class="modal-actions">
        <button 
          (click)="updateProductImages()" 
          class="btn-save"
          [disabled]="isUploadingImages()">
          @if (isUploadingImages()) {
            –ó–∞–≥—Ä—É–∑–∫–∞...
          } @else {
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          }
        </button>
        <button (click)="closeImageManager()" class="btn-cancel">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div class="products-list" *ngIf="!showForm">
    @if (products().length === 0) {
      <div class="empty-state">
        <p>–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä", —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä.</p>
      </div>
    } @else {
      @for (product of products(); track product.id) {
        <div class="product-item">
          <div class="product-image">
        <img [src]="getProductImageUrl(product)" 
            [alt]="product.name"
            (error)="handleImageError($event, product)">
          </div>
          <div class="product-info">
            <h4>{{ product.name }}</h4>
            <p class="product-description">{{ product.description | truncate:100 }}</p>
            <div class="product-details">
              <span class="product-price">{{ product.price | number:'1.0-0' }} ‚ÇΩ</span>
              <span class="product-category">{{ getCategoryName(product.categoryId) }}</span>
              <span class="product-stock">–û—Å—Ç–∞—Ç–æ–∫: {{ product.stock }}</span>
              <span class="product-images">–ò–∑–æ–±—Ä.: {{ product.imageUrls.length || 0 }}</span>
            </div>
          </div>
          <div class="product-actions">
            <button (click)="editProduct(product)" class="btn-sm btn-edit">
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button (click)="openImageManager(product)" class="btn-sm btn-secondary">
              –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            </button>
            <button (click)="deleteProduct(product)" class="btn-sm btn-danger">
              –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        </div>
      }
    }
  </div>
</div>