import{a as m}from"./chunk-EW5TGDZL.js";import{L as p,P as h,a as g,b as u,g as d}from"./chunk-PZHANSDG.js";var S=class c{constructor(e){this.supabaseService=e;this.initialize()}categoriesSubject=new d(this.getInitialCategories());categories$=this.categoriesSubject.asObservable();storageMode="local";storageKey="komfort_categories";async initialize(){this.storageMode=localStorage.getItem("komfort_storage_mode")||"supabase",console.log("=== CatalogService \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D ==="),console.log("\u0420\u0435\u0436\u0438\u043C \u0440\u0430\u0431\u043E\u0442\u044B:",this.storageMode),this.storageMode==="local"?this.loadFromLocalStorage():await this.loadFromSupabase(),console.log("\u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439:",this.getCategories().length),this.getCategories().forEach((e,t)=>{console.log(`\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F ${t+1}: ID=${e.id}, \u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435="${e.title}"`)})}getInitialCategories(){return[{id:1,title:"\u0413\u043E\u0441\u0442\u0438\u043D\u0430\u044F",image:"assets/livingroom.jpg",slug:"livingroom",order:1,isActive:!0,createdAt:new Date},{id:2,title:"\u0421\u043F\u0430\u043B\u044C\u043D\u044F",image:"assets/bedroom.jpg",slug:"bedroom",order:2,isActive:!0,createdAt:new Date},{id:3,title:"\u041A\u0443\u0445\u043D\u044F",image:"assets/kitchen.jpg",slug:"kitchen",order:3,isActive:!0,createdAt:new Date}]}loadFromLocalStorage(){let e=localStorage.getItem(this.storageKey);if(e)try{let o=JSON.parse(e).map(r=>u(g({},r),{createdAt:r.createdAt?new Date(r.createdAt):new Date}));this.categoriesSubject.next(o),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B \u0438\u0437 localStorage")}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439:",t),this.categoriesSubject.next(this.getInitialCategories())}else console.log("\u041D\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043D\u044B\u0445 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439, \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u044E\u0442\u0441\u044F \u043D\u0430\u0447\u0430\u043B\u044C\u043D\u044B\u0435"),this.categoriesSubject.next(this.getInitialCategories())}async loadFromSupabase(){try{console.log("\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0438\u0437 Supabase...");let e=await this.supabaseService.getCategories();console.log("\u041F\u043E\u043B\u0443\u0447\u0435\u043D\u043E \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0438\u0437 Supabase:",e),e&&e.length>0?(this.categoriesSubject.next(e),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u044B \u0432 BehaviorSubject:",e.length),this.saveToLocalStorage(e)):(console.log("Supabase \u043F\u0443\u0441\u0442, \u0437\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0438\u0437 localStorage"),this.loadFromLocalStorage())}catch(e){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437 Supabase:",e),console.log("\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0430\u0435\u043C\u0441\u044F \u043D\u0430 LocalStorage"),this.storageMode="local",this.loadFromLocalStorage()}}saveToLocalStorage(e){try{let o=(e||this.getCategories()).map(r=>u(g({},r),{image:r.image&&r.image.startsWith("data:image")?this.extractImageName(r.image):r.image}));localStorage.setItem(this.storageKey,JSON.stringify(o)),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B \u0432 localStorage (\u043A\u044D\u0448):",o.length)}catch(t){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0432 localStorage:",t)}}extractImageName(e){if(e.includes("/")){let t=e.split("/");return t[t.length-1]}return e}clearCache(){localStorage.removeItem("komfort_categories"),localStorage.removeItem("komfort_products"),console.log("\u{1F5D1}\uFE0F \u041E\u0447\u0438\u0449\u0435\u043D \u043A\u044D\u0448 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0438 \u0442\u043E\u0432\u0430\u0440\u043E\u0432")}getCategories(){return this.categoriesSubject.getValue()}async addCategory(e){console.log("\u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 \u0432 \u0440\u0435\u0436\u0438\u043C\u0435:",this.storageMode);let t=u(g({},e),{id:this.generateId(),createdAt:new Date});if(this.storageMode==="local"){let o=[...this.getCategories(),t];return this.categoriesSubject.next(o),this.saveToLocalStorage(o),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0430 \u0432 LocalStorage:",t),t}else try{let o=await this.supabaseService.addCategory(t);if(o){let r=[...this.getCategories(),o];return this.categoriesSubject.next(r),this.saveToLocalStorage(r),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0430 \u0432 Supabase:",o),o}else throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432 Supabase")}catch(o){return console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0432 Supabase:",o),this.storageMode="local",this.addCategory(e)}}async updateCategory(e,t){console.log("\u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 ID:",e,"\u0432 \u0440\u0435\u0436\u0438\u043C\u0435:",this.storageMode);let o=this.getCategories(),r=o.findIndex(i=>i.id===e);if(r===-1)return console.error(`\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u0441 id ${e} \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430`),null;let a=g(g({},o[r]),t),s=[...o];if(s[r]=a,this.categoriesSubject.next(s),this.storageMode==="local")this.saveToLocalStorage(s),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0430 \u0432 LocalStorage");else try{await this.supabaseService.updateCategory(e,t)?(this.saveToLocalStorage(s),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u0441 Supabase")):console.warn("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441 Supabase")}catch(i){console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438 \u0441 Supabase:",i)}return a}async deleteCategory(e){console.log("\u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 ID:",e,"\u0432 \u0440\u0435\u0436\u0438\u043C\u0435:",this.storageMode);let t=this.getCategories();if(!t.some(a=>a.id===e))return console.error(`\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u0441 id ${e} \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u0430`),!1;let r=t.filter(a=>a.id!==e);if(this.categoriesSubject.next(r),this.storageMode==="local")return this.saveToLocalStorage(r),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0438\u0437 LocalStorage"),!0;try{return await this.supabaseService.deleteCategory(e)?(this.saveToLocalStorage(r),console.log("\u041A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0430 \u0438\u0437 Supabase"),!0):(console.warn("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u0438\u0437 Supabase"),!1)}catch(a){return console.error("\u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0438\u0437 Supabase:",a),!1}}generateId(){let e=this.getCategories();return e.length===0?1:Math.max(...e.map(o=>o.id))+1}getCategoryById(e){return this.getCategories().find(t=>t.id===e)}getCategoryBySlug(e){return this.getCategories().find(t=>t.slug===e)}getStorageMode(){return this.storageMode}async switchStorageMode(e){this.storageMode!==e&&(console.log(`\u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0440\u0435\u0436\u0438\u043C\u0430 CatalogService \u0441 ${this.storageMode} \u043D\u0430 ${e}`),this.storageMode=e,e==="local"?this.loadFromLocalStorage():await this.loadFromSupabase())}async syncToSupabase(){if(this.storageMode==="supabase"){console.log("\u0423\u0436\u0435 \u0432 \u0440\u0435\u0436\u0438\u043C\u0435 Supabase, \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u043D\u0435 \u0442\u0440\u0435\u0431\u0443\u0435\u0442\u0441\u044F");return}console.log("\u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439 \u0441 Supabase...");let e=this.getCategories(),t=0;for(let o of e)try{await this.supabaseService.addCategory(o)&&(t++,console.log(`\u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D\u0430 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u044F: ${o.title}`))}catch(r){console.error(`\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438 ${o.title}:`,r)}console.log(`\u2705 \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D\u0430: ${t}/${e.length} \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439`)}async uploadCategoryImages(e){if(console.log(`\u{1F4E4} [CatalogService] \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 ${e.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439...`),this.storageMode!=="supabase")return console.warn("\u26A0\uFE0F \u0420\u0435\u0436\u0438\u043C \u043D\u0435 Supabase, \u0432\u043E\u0437\u0432\u0440\u0430\u0449\u0430\u0435\u043C \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 URL"),e.map(t=>URL.createObjectURL(t));try{let t=e.map(r=>this.uploadCategoryImage(r)),o=await Promise.all(t);return console.log("\u2705 \u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B:",o),o}catch(t){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",t),t}}async uploadCategoryImage(e){try{console.log("\u{1F4E4} [CatalogService] \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438...");let t=e.name.split(".").pop()?.toLowerCase()||"jpg",r=`categories/${`${Date.now()}_${Math.random().toString(36).substring(7)}.${t}`}`;console.log("\u{1F4C1} \u0424\u0430\u0439\u043B:",e.name),console.log("\u{1F4C2} \u041F\u0443\u0442\u044C \u0432 Storage:",r),console.log("\u{1F4CF} \u0420\u0430\u0437\u043C\u0435\u0440:",(e.size/1024/1024).toFixed(2),"MB");let a=this.supabaseService.getClient(),{data:s,error:i}=await a.storage.from("category-images").upload(r,e,{cacheControl:"3600",upsert:!1,contentType:e.type});if(i)throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438:",i),i;console.log("\u2705 \u0424\u0430\u0439\u043B \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D \u0432 Supabase:",s);let{data:n}=a.storage.from("category-images").getPublicUrl(r),l=n.publicUrl;return console.log("\u{1F517} \u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 URL:",l),l}catch(t){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0432 uploadCategoryImage:",t),t}}isSupabaseStorageUrl(e){return e.includes("supabase.co/storage")||e.includes("/storage/v1/object/public/")}static \u0275fac=function(t){return new(t||c)(h(m))};static \u0275prov=p({token:c,factory:c.\u0275fac,providedIn:"root"})};var b=class c{constructor(e){this.supabaseService=e}get supabaseClient(){let e=this.supabaseService;return e.getClient?e.getClient():e.supabase}PREFIX="komfort_";BUCKET_NAME="product-images";CATEGORIES_BUCKET="category-images";SLIDES_BUCKET="slides";SHOPS_BUCKET="shop-images";get supabase(){return this.supabaseService.getClient?this.supabaseService.getClient():this.supabaseService.supabase||this.supabaseService.supabaseClient}save(e,t){try{let o=this.PREFIX+e;sessionStorage.setItem(o,JSON.stringify(t)),localStorage.setItem(o,JSON.stringify(t)),console.log(`\u{1F4BE} \u041B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0435 \u0434\u0430\u043D\u043D\u044B\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B: ${o}`,t)}catch(o){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0432 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0435 \u0445\u0440\u0430\u043D\u0438\u043B\u0438\u0449\u0435:",o)}}load(e){try{let t=this.PREFIX+e,o=sessionStorage.getItem(t);return o||(o=localStorage.getItem(t)),o?JSON.parse(o):null}catch(t){return console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0433\u043E \u0445\u0440\u0430\u043D\u0438\u043B\u0438\u0449\u0430:",t),null}}clear(){let e=[];for(let t=0;t<localStorage.length;t++){let o=localStorage.key(t);o?.startsWith(this.PREFIX)&&e.push(o)}e.forEach(t=>{localStorage.removeItem(t),sessionStorage.removeItem(t)}),console.log("\u{1F9F9} \u041B\u043E\u043A\u0430\u043B\u044C\u043D\u043E\u0435 \u0445\u0440\u0430\u043D\u0438\u043B\u0438\u0449\u0435 \u043E\u0447\u0438\u0449\u0435\u043D\u043E")}async uploadFile(e,t=this.BUCKET_NAME,o){try{if(!this.isImageFile(e))throw new Error("\u0424\u0430\u0439\u043B \u0434\u043E\u043B\u0436\u0435\u043D \u0431\u044B\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435\u043C");if(!this.validateFileSize(e,10))throw new Error("\u0420\u0430\u0437\u043C\u0435\u0440 \u0444\u0430\u0439\u043B\u0430 \u043D\u0435 \u0434\u043E\u043B\u0436\u0435\u043D \u043F\u0440\u0435\u0432\u044B\u0448\u0430\u0442\u044C 10MB");let r=e.name.split(".").pop()?.toLowerCase()||"jpg",a=this.generateUniqueFileName(r),s=o?`${o}/${a}`:a;console.log("\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0444\u0430\u0439\u043B\u0430 \u0432 Supabase Storage:"),console.log(`   Bucket: ${t}`),console.log(`   \u041F\u0443\u0442\u044C: ${s}`),console.log(`   \u0420\u0430\u0437\u043C\u0435\u0440: ${(e.size/1024/1024).toFixed(2)} MB`),console.log(`   \u0422\u0438\u043F: ${e.type}`);let{data:i,error:n}=await this.supabase.storage.from(t).upload(s,e,{cacheControl:"3600",upsert:!1,contentType:e.type});if(n)throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0444\u0430\u0439\u043B\u0430 \u0432 Supabase:",n),n;console.log("\u2705 \u0424\u0430\u0439\u043B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D:",i);let l=this.getPublicUrl(s,t);return console.log("\u{1F517} \u041F\u0443\u0431\u043B\u0438\u0447\u043D\u044B\u0439 URL:",l),l}catch(r){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0432 uploadFile:",r),r}}async uploadMultipleFiles(e,t,o){console.log(`\u{1F4E4} \u041D\u0430\u0447\u0438\u043D\u0430\u044E \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0443 ${e.length} \u0444\u0430\u0439\u043B\u043E\u0432...`);let r=e.map((a,s)=>(console.log(`   \u0424\u0430\u0439\u043B ${s+1}: ${a.name} (${(a.size/1024).toFixed(1)} KB)`),this.uploadFile(a,t,o)));try{let a=await Promise.all(r);return console.log(`\u2705 \u0412\u0441\u0435 \u0444\u0430\u0439\u043B\u044B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B: ${a.length} \u0448\u0442.`),a}catch(a){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u0438\u0445 \u0444\u0430\u0439\u043B\u043E\u0432:",a),a}}getPublicUrl(e,t=this.BUCKET_NAME){try{let{data:o}=this.supabase.storage.from(t).getPublicUrl(e);return o.publicUrl}catch(o){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u043F\u0443\u0431\u043B\u0438\u0447\u043D\u043E\u0433\u043E URL:",o),o}}async deleteFile(e,t=this.BUCKET_NAME){try{console.log(`\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 \u0444\u0430\u0439\u043B\u0430 \u0438\u0437 Supabase: ${e} (bucket: ${t})`);let{error:o}=await this.supabase.storage.from(t).remove([e]);if(o)throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0444\u0430\u0439\u043B\u0430:",o),o;console.log("\u2705 \u0424\u0430\u0439\u043B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0443\u0434\u0430\u043B\u0435\u043D")}catch(o){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0432 deleteFile:",o),o}}async deleteMultipleFiles(e,t){if(e.length!==0)try{console.log(`\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 ${e.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u0438\u0437 Supabase...`);let{error:o}=await this.supabase.storage.from(t||this.BUCKET_NAME).remove(e);if(o)throw o;console.log("\u2705 \u0424\u0430\u0439\u043B\u044B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0443\u0434\u0430\u043B\u0435\u043D\u044B")}catch(o){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u043D\u0435\u0441\u043A\u043E\u043B\u044C\u043A\u0438\u0445 \u0444\u0430\u0439\u043B\u043E\u0432:",o),o}}async uploadProductImage(e){return this.uploadFile(e,this.BUCKET_NAME,"products")}async uploadCategoryImage(e){return this.uploadFile(e,this.CATEGORIES_BUCKET,"categories")}async uploadShopImage(e){return this.uploadFile(e,this.SHOPS_BUCKET,"shops")}async uploadSlideImage(e){return this.uploadFile(e,this.SLIDES_BUCKET,"slides")}isImageFile(e){return["image/jpeg","image/jpg","image/png","image/webp","image/gif","image/svg+xml"].includes(e.type.toLowerCase())}validateFileSize(e,t){let o=t*1024*1024;return e.size<=o}generateUniqueFileName(e){let t=Date.now(),o=Math.random().toString(36).substring(2,9);return`${t}_${o}.${e}`}extractFileNameFromUrl(e){try{let o=new URL(e).pathname.split("/");return o[o.length-1]}catch{return e}}extractFilePathFromUrl(e){try{let o=new URL(e).pathname,r=o.match(/\/storage\/v1\/object\/public\/[^/]+\/(.+)/);return r?r[1]:o}catch{return e}}getBucketFromUrl(e){try{let r=new URL(e).pathname.match(/\/storage\/v1\/object\/public\/([^/]+)/);return r?r[1]:this.BUCKET_NAME}catch{return this.BUCKET_NAME}}isSupabaseStorageUrl(e){return e.includes("supabase.co/storage")||e.includes("/storage/v1/object/public/")}base64ToFile(e,t){let o=e.split(","),r=o[0].match(/:(.*?);/)?.[1]||"image/jpeg",a=atob(o[1]),s=a.length,i=new Uint8Array(s);for(;s--;)i[s]=a.charCodeAt(s);return new File([i],t,{type:r})}async downloadFileFromUrl(e){try{let o=await(await fetch(e)).blob(),r=this.extractFileNameFromUrl(e)||`downloaded_${Date.now()}.jpg`;return new File([o],r,{type:o.type})}catch(t){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0444\u0430\u0439\u043B\u0430 \u043F\u043E URL:",t),t}}async createBucket(e,t=!0){try{console.log(`\u{1F6E0}\uFE0F \u0421\u043E\u0437\u0434\u0430\u043D\u0438\u0435 bucket'\u0430: ${e} (public: ${t})`),console.warn("\u26A0\uFE0F Bucket'\u044B \u0441\u043E\u0437\u0434\u0430\u044E\u0442\u0441\u044F \u0447\u0435\u0440\u0435\u0437 \u043F\u0430\u043D\u0435\u043B\u044C \u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0430 Supabase"),console.warn("   \u041F\u0435\u0440\u0435\u0439\u0434\u0438\u0442\u0435 \u0432: Supabase \u2192 Storage \u2192 Create New Bucket"),console.warn(`   \u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435: ${e}`),console.warn(`   Public: ${t?"Yes":"No"}`),await this.checkBucketExists(e)}catch(o){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0440\u0430\u0431\u043E\u0442\u044B \u0441 bucket'\u043E\u043C:",o),o}}async checkBucketExists(e){try{let{data:t,error:o}=await this.supabase.storage.from(e).list();return!(o&&o.message.includes("not found"))}catch{return!1}}async initializeBuckets(){console.log("\u{1F6E0}\uFE0F \u0418\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F bucket'\u043E\u0432...");let e=[{name:this.BUCKET_NAME,description:"\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u043E\u0432"},{name:this.CATEGORIES_BUCKET,description:"\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0439"},{name:this.SLIDES_BUCKET,description:"\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0441\u043B\u0430\u0439\u0434\u043E\u0432"},{name:this.SHOPS_BUCKET,description:"\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u043C\u0430\u0433\u0430\u0437\u0438\u043D\u043E\u0432"}];for(let t of e)try{await this.checkBucketExists(t.name)?console.log(`\u2705 Bucket "${t.name}" \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D`):(console.warn(`\u26A0\uFE0F Bucket "${t.name}" \u043D\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442!`),console.warn("   \u0421\u043E\u0437\u0434\u0430\u0439\u0442\u0435 \u0435\u0433\u043E \u0432 \u043F\u0430\u043D\u0435\u043B\u0438 Supabase: Storage \u2192 New Bucket"),console.warn(`   \u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435: ${t.name}`),console.warn("   Public: Yes"),console.warn(`   \u041E\u043F\u0438\u0441\u0430\u043D\u0438\u0435: ${t.description}`))}catch(o){console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 bucket'\u0430 "${t.name}":`,o)}}async getStorageInfo(){try{console.log("\u{1F4CA} \u041F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u0435 \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u0438 \u043E Storage...");let e=[this.BUCKET_NAME,this.CATEGORIES_BUCKET,this.SLIDES_BUCKET,this.SHOPS_BUCKET],t=[],o=0,r=0;for(let a of e)try{let{data:s,error:i}=await this.supabase.storage.from(a).list();if(i){console.warn(`\u26A0\uFE0F \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0444\u0430\u0439\u043B\u043E\u0432 \u0438\u0437 bucket'\u0430 ${a}:`,i.message);continue}if(s){let n=s.length,l=s.reduce((y,C)=>y+(C.metadata?.size||0),0);t.push({name:a,fileCount:n,size:l}),o+=n,r+=l}}catch(s){console.warn(`\u26A0\uFE0F \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0430\u0435\u043C bucket ${a}:`,s)}return{totalFiles:o,totalSize:r,buckets:t}}catch(e){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u044F \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u0438 \u043E Storage:",e),e}}async logStorageInfo(){try{let e=await this.getStorageInfo();console.log("\u{1F4CA} =========== \u0418\u041D\u0424\u041E\u0420\u041C\u0410\u0426\u0418\u042F \u041E STORAGE ==========="),console.log(`\u{1F4C1} \u0412\u0441\u0435\u0433\u043E \u0444\u0430\u0439\u043B\u043E\u0432: ${e.totalFiles}`),console.log(`\u{1F4BE} \u041E\u0431\u0449\u0438\u0439 \u0440\u0430\u0437\u043C\u0435\u0440: ${(e.totalSize/1024/1024).toFixed(2)} MB`),console.log(""),e.buckets.forEach(t=>{console.log(`\u{1FAA3} ${t.name}:`),console.log(`   \u{1F4C4} \u0424\u0430\u0439\u043B\u043E\u0432: ${t.fileCount}`),console.log(`   \u{1F4BE} \u0420\u0430\u0437\u043C\u0435\u0440: ${(t.size/1024/1024).toFixed(2)} MB`)}),console.log("=============================================")}catch(e){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043B\u043E\u0433\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F \u0438\u043D\u0444\u043E\u0440\u043C\u0430\u0446\u0438\u0438 \u043E Storage:",e)}}static \u0275fac=function(t){return new(t||c)(h(m))};static \u0275prov=p({token:c,factory:c.\u0275fac,providedIn:"root"})};export{S as a,b};
