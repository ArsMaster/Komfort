import{a as u}from"./chunk-WCF7E4PB.js";import{L as r,P as l,a as s,g as i,p as c}from"./chunk-TFJ7GAPU.js";var h=class n{constructor(t){this.supabaseService=t;console.log("=== ContactService \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D ==="),this.initializeSync()}contactsSubject=new i(this.getEmptyContacts());contacts$=this.contactsSubject.asObservable();loadingSubject=new i(!0);loading$=this.loadingSubject.asObservable();isInitialized=!1;CACHE_KEY="contacts_fallback_cache";cacheLoaded=!1;initializeSync(){console.log("\u26A1 \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u043D\u0430\u044F \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u044F ContactService"),this.loadingSubject.next(!0),this.loadFromSupabase().then(()=>{this.isInitialized=!0,console.log("\u2705 ContactService \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D")}).catch(t=>{console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u0438:",t),this.isInitialized=!0})}async loadFromCacheAsFallback(){console.log("\u{1F504} \u041F\u043E\u043F\u044B\u0442\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437 fallback \u043A\u044D\u0448\u0430...");try{let t=localStorage.getItem(this.CACHE_KEY);if(t){let o=JSON.parse(t);console.log("\u{1F4BE} \u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E \u0438\u0437 fallback \u043A\u044D\u0448\u0430"),this.contactsSubject.next(o),this.cacheLoaded=!0}else console.log("\u{1F4ED} Fallback \u043A\u044D\u0448 \u043F\u0443\u0441\u0442")}catch(t){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437 \u043A\u044D\u0448\u0430:",t)}}saveToCache(t){try{localStorage.setItem(this.CACHE_KEY,JSON.stringify(t)),console.log("\u{1F4BE} \u0414\u0430\u043D\u043D\u044B\u0435 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B \u0432 fallback \u043A\u044D\u0448")}catch(o){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0432 \u043A\u044D\u0448:",o)}}async loadFromSupabase(){console.log("\u{1F504} loadFromSupabase called");try{this.loadingSubject.next(!0);let t=await this.supabaseService.getContactInfo();if(t){console.log("\u{1F4E6} \u0414\u0430\u043D\u043D\u044B\u0435 \u0438\u0437 Supabase:",t);let o={id:t.id,phone:t.phone||"",email:t.email||"",office:t.office||"",workingHours:t.workingHours||"",mapEmbed:t.mapEmbed||"",social:t.social||[],aboutSections:t.about_sections||[]};console.log("\u{1F4CA} Transformed contacts with aboutSections:",o),this.contactsSubject.next(o),this.saveToCache(o),console.log("\u2705 Contacts loaded and emitted with aboutSections")}else console.log("\u{1F4ED} No contacts in Supabase")}catch(t){console.error("\u274C Error loading from Supabase:",t)}finally{this.loadingSubject.next(!1)}}async getContactsAsync(){let t=this.getContacts();return t.id!==0?t:this.isLoading()?c(this.contacts$):(await this.loadFromSupabase(),this.getContacts())}async updateContacts(t){console.log("\u270F\uFE0F \u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043A\u043E\u043D\u0442\u0430\u043A\u0442\u043E\u0432 \u0432 Supabase...");let o=this.getContacts(),e=s(s({},o),t);try{return await this.supabaseService.updateContactInfo(e)?(this.contactsSubject.next(e),this.saveToCache(e),console.log("\u2705 \u041A\u043E\u043D\u0442\u0430\u043A\u0442\u044B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u044B \u0432 Supabase \u0438 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u043E"),!0):(console.warn("\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043E\u0431\u043D\u043E\u0432\u0438\u0442\u044C \u043A\u043E\u043D\u0442\u0430\u043A\u0442\u044B \u0432 Supabase"),!1)}catch(a){return console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F \u0432 Supabase:",a),!1}}emitCurrentContacts(){let t=this.getContacts();console.log("\u{1F4E4} \u041F\u0440\u0438\u043D\u0443\u0434\u0438\u0442\u0435\u043B\u044C\u043D\u0430\u044F \u044D\u043C\u0438\u0441\u0441\u0438\u044F \u0442\u0435\u043A\u0443\u0449\u0438\u0445 \u043A\u043E\u043D\u0442\u0430\u043A\u0442\u043E\u0432:",t.id),this.contactsSubject.next(t)}async refreshContacts(){console.log("\u{1F504} \u041F\u0440\u0438\u043D\u0443\u0434\u0438\u0442\u0435\u043B\u044C\u043D\u0430\u044F \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0441\u0432\u0435\u0436\u0438\u0445 \u0434\u0430\u043D\u043D\u044B\u0445..."),localStorage.removeItem(this.CACHE_KEY),this.loadingSubject.next(!0),await this.loadFromSupabase()}isLoading(){return this.loadingSubject.getValue()}getEmptyContacts(){return{id:0,phone:"",email:"",office:"",workingHours:"",mapEmbed:"",social:[]}}async addSocial(t){console.log("\u2795 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u0441\u043E\u0446\u0438\u0430\u043B\u044C\u043D\u043E\u0439 \u0441\u0435\u0442\u0438...");let e=[...this.getContacts().social,t];return await this.updateContacts({social:e})}async removeSocial(t){console.log(`\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 \u0441\u043E\u0446\u0438\u0430\u043B\u044C\u043D\u043E\u0439 \u0441\u0435\u0442\u0438 (\u0438\u043D\u0434\u0435\u043A\u0441: ${t})...`);let o=this.getContacts();if(t<0||t>=o.social.length)return console.error("\u274C \u041D\u0435\u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u044B\u0439 \u0438\u043D\u0434\u0435\u043A\u0441 \u0441\u043E\u0446\u0438\u0430\u043B\u044C\u043D\u043E\u0439 \u0441\u0435\u0442\u0438"),!1;let e=o.social.filter((a,d)=>d!==t);return await this.updateContacts({social:e})}async updateSocial(t,o){console.log(`\u270F\uFE0F \u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0441\u043E\u0446\u0438\u0430\u043B\u044C\u043D\u043E\u0439 \u0441\u0435\u0442\u0438 (\u0438\u043D\u0434\u0435\u043A\u0441: ${t})...`);let e=this.getContacts();if(t<0||t>=e.social.length)return console.error("\u274C \u041D\u0435\u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u044B\u0439 \u0438\u043D\u0434\u0435\u043A\u0441 \u0441\u043E\u0446\u0438\u0430\u043B\u044C\u043D\u043E\u0439 \u0441\u0435\u0442\u0438"),!1;let a=[...e.social];return a[t]=s(s({},a[t]),o),await this.updateContacts({social:a})}getStorageMode(){return"supabase"}switchStorageMode(t){console.warn("\u26A0\uFE0F \u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0440\u0435\u0436\u0438\u043C\u0430 \u043D\u0435 \u043F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u0435\u0442\u0441\u044F. \u041A\u043E\u043D\u0442\u0430\u043A\u0442\u044B \u0440\u0430\u0431\u043E\u0442\u0430\u044E\u0442 \u0422\u041E\u041B\u042C\u041A\u041E \u0441 Supabase")}clearCache(){console.log('\u{1F504} "\u041E\u0447\u0438\u0441\u0442\u043A\u0430 \u043A\u044D\u0448\u0430" - \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0438\u0437 Supabase...'),this.refreshContacts()}getStatus(){let t=this.getContacts();return{isInitialized:this.isInitialized,isLoading:this.loadingSubject.getValue(),hasData:!!(t.phone||t.email||t.office),cacheLoaded:this.cacheLoaded}}async testConnection(){console.log("\u{1F50C} \u0422\u0435\u0441\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F \u043A Supabase...");try{let t=await this.supabaseService.getContactInfo();return console.log("\u2705 \u041F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u043A Supabase \u0443\u0441\u043F\u0435\u0448\u043D\u043E"),!0}catch(t){return console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F:",t.message||t),!1}}async saveContacts(t){return console.log("\u{1F4BE} \u0421\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435 \u043A\u043E\u043D\u0442\u0430\u043A\u0442\u043E\u0432 \u0438\u0437 \u0430\u0434\u043C\u0438\u043D-\u043F\u0430\u043D\u0435\u043B\u0438..."),await this.updateContacts(t)}async checkForUpdates(){console.log("\u{1F50D} \u041F\u0440\u043E\u0432\u0435\u0440\u043A\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0439 \u0432 Supabase...");try{let t=await this.supabaseService.getContactInfo();if(!t)return{hasChanges:!1,local:this.getContacts(),remote:null};let o={id:t.id,phone:t.phone||"",email:t.email||"",office:t.office||"",workingHours:t.workingHours||"",mapEmbed:t.mapEmbed||"",social:t.social||[]},e=this.getContacts(),a=JSON.stringify(e)!==JSON.stringify(o);return console.log(`\u{1F4CA} \u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438: ${a?"\u0415\u0441\u0442\u044C \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u044F":"\u041D\u0435\u0442 \u0438\u0437\u043C\u0435\u043D\u0435\u043D\u0438\u0439"}`),{hasChanges:a,local:e,remote:o}}catch(t){return console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u043E\u0432\u0435\u0440\u043A\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0439:",t),{hasChanges:!1,local:this.getContacts(),remote:null}}}async syncWithSupabase(){console.log("\u{1F517} \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u0441 Supabase..."),await this.refreshContacts()}async ensureContactsLoaded(){let t=this.getContacts();return t.id!==0?t:this.isLoading()?new Promise(o=>{let e=this.contacts$.subscribe(a=>{a.id!==0&&(e.unsubscribe(),o(a))})}):(await this.loadFromSupabase(),this.getContacts())}initializationPromise=null;async initialize(){return this.initializationPromise?this.initializationPromise:(this.initializationPromise=(async()=>{this.isInitialized||(console.log("\u{1F504} ContactService: \u0437\u0430\u043F\u0443\u0441\u043A \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0430\u0446\u0438\u0438..."),await this.loadFromSupabase(),this.isInitialized=!0)})(),this.initializationPromise)}getContacts(){return this.contactsSubject.getValue()}async ensureLoaded(){return await this.initialize(),this.getContacts()}async restoreDefaults(){console.log("\u{1F504} \u0412\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u0430\u0447\u0430\u043B\u044C\u043D\u044B\u0445 \u043A\u043E\u043D\u0442\u0430\u043A\u0442\u043E\u0432...");let t={id:1,phone:"+7 (938) 505-00-07",email:"komfort.smm@mail.ru",office:'\u0433. \u0428\u0435\u043B\u043A\u043E\u0432\u0441\u043A\u0430\u044F, \u0443\u043B. \u041A\u043E\u0441\u0430\u044F, 47, \u0422\u0414 "\u041A\u043E\u043C\u0444\u043E\u0440\u0442"',social:[{name:"Instagram",url:"https://www.instagram.com/td_komfort_shelk/",icon:"IN"},{name:"Telegram",url:"https://t.me/komfort_company",icon:"TG"},{name:"WhatsApp",url:"https://wa.me/78005553535",icon:"WA"}],workingHours:"\u041F\u043D-\u041F\u0442: 9:00-18:00, \u0421\u0431: 10:00-16:00",mapEmbed:""};await this.updateContacts(t)?console.log("\u2705 \u041D\u0430\u0447\u0430\u043B\u044C\u043D\u044B\u0435 \u043A\u043E\u043D\u0442\u0430\u043A\u0442\u044B \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u043B\u0435\u043D\u044B \u0432 Supabase"):console.warn("\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0432\u043E\u0441\u0441\u0442\u0430\u043D\u043E\u0432\u0438\u0442\u044C \u043D\u0430\u0447\u0430\u043B\u044C\u043D\u044B\u0435 \u043A\u043E\u043D\u0442\u0430\u043A\u0442\u044B \u0432 Supabase")}debugInfo(){return{status:this.getStatus(),contacts:this.getContacts(),isLoading:this.isLoading(),isInitialized:this.isInitialized}}static \u0275fac=function(o){return new(o||n)(l(u))};static \u0275prov=r({token:n,factory:n.\u0275fac,providedIn:"root"})};export{h as a};
