import{a as $}from"./chunk-USITXSJS.js";import{a as v}from"./chunk-WCF7E4PB.js";import{L as U,Q as P,a as u,b as p,fa as f,ha as w}from"./chunk-TFJ7GAPU.js";var M=class y{supabaseService=P(v);storageService=P($);products=f([],{});storageMode=f("supabase",{});isLoading=f(!1,{});isUploadingImages=f(!1,{});storageKey="komfort_products";constructor(){w(()=>{this.storageMode()==="local"&&this.saveToLocalStorage(this.products())}),this.initialize()}async initialize(){console.log("=== ProductService \u0438\u043D\u0438\u0446\u0438\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D ===");let t=localStorage.getItem("komfort_storage_mode")||"supabase";this.storageMode.set(t),console.log(`\u0420\u0435\u0436\u0438\u043C \u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F: ${t}`),t==="local"?this.loadFromLocalStorage():await this.loadFromSupabase()}loadFromLocalStorage(){try{let t=localStorage.getItem(this.storageKey);if(t){let e=JSON.parse(t).map(o=>p(u({},o),{imageUrls:this.cleanImageUrls(o.imageUrls||[]),createdAt:o.createdAt?new Date(o.createdAt):new Date,updatedAt:o.updatedAt?new Date(o.updatedAt):new Date}));this.products.set(e),console.log("\u{1F4E6} \u0422\u043E\u0432\u0430\u0440\u044B \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B \u0438\u0437 localStorage:",e.length)}else console.log("\u{1F4ED} \u041D\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u043D\u044B\u0445 \u0442\u043E\u0432\u0430\u0440\u043E\u0432, \u0438\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u044E\u0442\u0441\u044F \u043D\u0430\u0447\u0430\u043B\u044C\u043D\u044B\u0435"),this.products.set(this.getInitialProducts())}catch(t){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437 localStorage:",t),this.products.set(this.getInitialProducts())}}saveToLocalStorage(t){try{localStorage.setItem(this.storageKey,JSON.stringify(t)),console.log("\u{1F4BE} \u0422\u043E\u0432\u0430\u0440\u044B \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u044B \u0432 localStorage (\u043A\u044D\u0448):",t.length)}catch(s){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u044F \u0432 localStorage:",s)}}getInitialProducts(){return[{id:1,name:'\u0414\u0438\u0432\u0430\u043D "\u041A\u043E\u043C\u0444\u043E\u0440\u0442"',description:"\u0423\u0434\u043E\u0431\u043D\u044B\u0439 \u0434\u0438\u0432\u0430\u043D \u0434\u043B\u044F \u0433\u043E\u0441\u0442\u0438\u043D\u043E\u0439",price:29999,categoryId:1,categoryName:"\u0413\u043E\u0441\u0442\u0438\u043D\u0430\u044F",imageUrls:["/assets/sofa1.jpg"],stock:5,features:["\u0420\u0430\u0441\u043A\u043B\u0430\u0434\u043D\u043E\u0439","\u0422\u043A\u0430\u043D\u044C - \u0432\u0435\u043B\u044E\u0440"],createdAt:new Date,updatedAt:new Date},{id:2,name:'\u041A\u0440\u043E\u0432\u0430\u0442\u044C "\u041E\u0440\u0442\u043E"',description:"\u041E\u0440\u0442\u043E\u043F\u0435\u0434\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u043A\u0440\u043E\u0432\u0430\u0442\u044C",price:45999,categoryId:2,categoryName:"\u0421\u043F\u0430\u043B\u044C\u043D\u044F",imageUrls:["/assets/bed1.jpg"],stock:3,features:["\u041E\u0440\u0442\u043E\u043F\u0435\u0434\u0438\u0447\u0435\u0441\u043A\u043E\u0435 \u043E\u0441\u043D\u043E\u0432\u0430\u043D\u0438\u0435","\u042F\u0449\u0438\u043A\u0438 \u0434\u043B\u044F \u0431\u0435\u043B\u044C\u044F"],createdAt:new Date,updatedAt:new Date}]}generateId(){let s=this.products().map(e=>typeof e.id=="number"?e.id:parseInt(e.id)).filter(e=>!isNaN(e));return s.length>0?Math.max(...s)+1:1}async compressImage(t,s=1200,e=.8,o="image/jpeg"){return new Promise((a,r)=>{console.log(`\u{1F4CA} \u041D\u0430\u0447\u0438\u043D\u0430\u0435\u043C \u0441\u0436\u0430\u0442\u0438\u0435: ${t.name} (${(t.size/1024).toFixed(1)} KB)`);let i=new FileReader,n=new Image,c=document.createElement("canvas"),m=c.getContext("2d");i.onload=g=>{n.onload=()=>{try{let l=n.width,d=n.height;if(console.log(`\u{1F4CF} \u0418\u0441\u0445\u043E\u0434\u043D\u044B\u0435 \u0440\u0430\u0437\u043C\u0435\u0440\u044B: ${l}x${d}`),l>s){let h=s/l;d=Math.round(d*h),l=s,console.log(`\u{1F4D0} \u041D\u043E\u0432\u044B\u0435 \u0440\u0430\u0437\u043C\u0435\u0440\u044B: ${l}x${d}`)}c.width=l,c.height=d,m.drawImage(n,0,0,l,d),c.toBlob(h=>{if(h){let b=o==="image/png"?"png":"jpg",S=t.name.replace(/\.[^/.]+$/,"")+`_compressed.${b}`,I=new File([h],S,{type:o,lastModified:Date.now()});console.log("\u2705 \u0421\u0436\u0430\u0442\u0438\u0435 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D\u043E:"),console.log(`   \u041E\u0440\u0438\u0433\u0438\u043D\u0430\u043B: ${(t.size/1024).toFixed(1)} KB`),console.log(`   \u041F\u043E\u0441\u043B\u0435 \u0441\u0436\u0430\u0442\u0438\u044F: ${(I.size/1024).toFixed(1)} KB`),console.log(`   \u042D\u043A\u043E\u043D\u043E\u043C\u0438\u044F: ${((1-I.size/t.size)*100).toFixed(1)}%`),a(I)}else r(new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0437\u0434\u0430\u0442\u044C \u0441\u0436\u0430\u0442\u043E\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435"))},o,e)}catch(l){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0441\u0436\u0430\u0442\u0438\u0438:",l),r(l)}},n.onerror=()=>{r(new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0434\u043B\u044F \u0441\u0436\u0430\u0442\u0438\u044F"))},n.src=g.target.result},i.onerror=()=>{r(new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u043F\u0440\u043E\u0447\u0438\u0442\u0430\u0442\u044C \u0444\u0430\u0439\u043B"))},i.readAsDataURL(t)})}getCompressionSettings(t){let s=t.type==="image/png";return{maxWidth:t.size>2*1024*1024?1e3:1200,quality:s?.9:.85,format:s?"image/png":"image/jpeg"}}cleanImageUrls(t){return!t||!Array.isArray(t)?["/assets/default-product.jpg"]:t.filter(s=>s&&typeof s=="string").map(s=>{let e=s.trim();return e.startsWith("data:image")?"/assets/default-product.jpg":(this.isSupabaseStorageUrl(e)||e.startsWith("http")||(e.startsWith("{")&&e.endsWith("}")&&(e=e.slice(1,-1).trim()),e.includes("assets//assets/")&&(e=e.replace("assets//assets/","/assets/")),e.startsWith("/assets/")||(e.startsWith("assets/")?e="/"+e:e.startsWith("/")?e="/assets"+e:e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".png")||e.endsWith(".gif")||e.endsWith(".webp")?e="/assets/"+e:e="/assets/default-product.jpg")),e)}).filter(s=>s&&s.trim()!=="")}async loadFromSupabase(){this.isLoading.set(!0);try{console.log("\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0438\u0437 Supabase...");let t=await this.supabaseService.getProducts();if(console.log("\u{1F4E6} RAW \u0434\u0430\u043D\u043D\u044B\u0435 \u0438\u0437 Supabase:",t),t.length>0){let s=await Promise.all(t.map(async e=>{let o=this.cleanImageUrls(e.imageUrls||[]);return console.log(`\u{1F504} \u041A\u043E\u043D\u0432\u0435\u0440\u0442\u0430\u0446\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430 "${e.name}":`),console.log("  \u0418\u0441\u0445\u043E\u0434\u043D\u044B\u0435 imageUrls:",e.imageUrls),console.log("  \u041E\u0447\u0438\u0449\u0435\u043D\u043D\u044B\u0435 imageUrls:",o),{id:e.id,name:e.name||"",description:e.description||"",price:e.price||0,categoryId:typeof e.categoryId=="number"?e.categoryId:1,categoryName:e.categoryName||"\u0411\u0435\u0437 \u043A\u0430\u0442\u0435\u0433\u043E\u0440\u0438\u0438",imageUrls:o,stock:e.stock||0,features:e.features||[],createdAt:e.createdAt?new Date(e.createdAt):new Date,updatedAt:e.updatedAt?new Date(e.updatedAt):new Date}}));this.products.set(s),console.log("\u2705 \u0422\u043E\u0432\u0430\u0440\u044B \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B \u0438\u0437 Supabase:"),s.forEach((e,o)=>{console.log(`  ${o+1}. ${e.name}:`,e.imageUrls)}),this.saveToLocalStorage(s)}else console.log("\u{1F4ED} \u0412 Supabase \u043D\u0435\u0442 \u0442\u043E\u0432\u0430\u0440\u043E\u0432"),this.products.set(this.getInitialProducts())}catch(t){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437 Supabase:",t),this.loadFromLocalStorage()}finally{this.isLoading.set(!1)}}getProducts(){return this.products.asReadonly()}getProductsArray(){return this.products()}getProductById(t){return this.products().find(s=>s.id==t)}getProductsByCategoryId(t){return this.products().filter(s=>s.categoryId===t)}getStorageMode(){return this.storageMode()}getIsLoading(){return this.isLoading.asReadonly()}getIsUploadingImages(){return this.isUploadingImages.asReadonly()}async uploadProductImages(t){this.isUploadingImages.set(!0);try{console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 ${t.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0442\u043E\u0432\u0430\u0440\u0430 \u0441\u043E \u0441\u0436\u0430\u0442\u0438\u0435\u043C...`);let s=t.map(async(o,a)=>{try{let r=this.getCompressionSettings(o);console.log(`\u{1F39B}\uFE0F [${a+1}] \u041F\u0430\u0440\u0430\u043C\u0435\u0442\u0440\u044B \u0441\u0436\u0430\u0442\u0438\u044F: ${JSON.stringify(r)}`);let i=await this.compressImage(o,r.maxWidth,r.quality,r.format),n=Date.now(),c=Math.random().toString(36).substring(2,8),m=i.type==="image/png"?"png":"jpg",g=`product_${n}_${a}_${c}.${m}`,l=`products/${g}`,d=this.supabaseService.getClient();console.log(`\u{1F4C1} [${a+1}] \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0441\u0436\u0430\u0442\u044B\u0439 \u0444\u0430\u0439\u043B: ${g}`);let{data:h,error:b}=await d.storage.from("product-images").upload(l,i,{cacheControl:"86400",upsert:!1,contentType:i.type});if(b)return console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0444\u0430\u0439\u043B\u0430 ${a+1}:`,b),console.log(`\u{1F504} [${a+1}] Fallback: \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0431\u0435\u0437 \u0441\u0436\u0430\u0442\u0438\u044F...`),await this.uploadSingleImageWithoutCompression(o,a);let{data:S}=d.storage.from("product-images").getPublicUrl(l);return console.log(`\u2705 [${a+1}] \u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043E:`,S.publicUrl),S.publicUrl}catch(r){return console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0438 \u0444\u0430\u0439\u043B\u0430 ${a+1}:`,r),"/assets/default-product.jpg"}}),e=await Promise.all(s);return console.log("\u2705 \u0412\u0441\u0435 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B:",e),e}catch(s){throw console.error("\u274C \u041E\u0431\u0449\u0430\u044F \u043E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",s),s}finally{this.isUploadingImages.set(!1)}}async uploadSingleImageWithoutCompression(t,s){console.warn(`\u26A0\uFE0F [${s+1}] \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C \u0431\u0435\u0437 \u0441\u0436\u0430\u0442\u0438\u044F (fallback)`);let e=Date.now(),o=Math.random().toString(36).substring(2,8),a=t.name.split(".").pop()?.toLowerCase()||"jpg",i=`products/${`product_${e}_${s}_${o}.${a}`}`,n=this.supabaseService.getClient(),{data:c,error:m}=await n.storage.from("product-images").upload(i,t,{cacheControl:"86400",upsert:!1,contentType:t.type});if(m)return console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 fallback \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438:",m),"/assets/default-product.jpg";let{data:g}=n.storage.from("product-images").getPublicUrl(i);return g.publicUrl}async uploadProductImagesWithoutCompression(t){console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 ${t.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0411\u0415\u0417 \u0441\u0436\u0430\u0442\u0438\u044F...`);try{let s=[];for(let e of t){let o=Date.now(),a=Math.random().toString(36).substring(2,8),r=e.name.split(".").pop()?.toLowerCase()||"jpg",n=`products/${`product_${o}_${a}.${r}`}`,c=this.supabaseService.getClient(),{data:m,error:g}=await c.storage.from("product-images").upload(n,e,{cacheControl:"86400",upsert:!1,contentType:e.type});if(g)throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438:",g),g;let{data:l}=c.storage.from("product-images").getPublicUrl(n);s.push(l.publicUrl)}return console.log("\u2705 \u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u044B (\u0431\u0435\u0437 \u0441\u0436\u0430\u0442\u0438\u044F):",s),s}catch(s){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043A\u0438 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",s),s}}async deleteProductImages(t){try{console.log(`\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 ${t.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0442\u043E\u0432\u0430\u0440\u0430...`);let s=t.map(e=>this.extractFilePathFromUrl(e)).filter(e=>e!==null&&!e.includes("default-product.jpg"));if(s.length>0){let e=this.supabaseService.getClient();for(let o of s){let{error:a}=await e.storage.from("product-images").remove([o]);a&&console.warn(`\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u0444\u0430\u0439\u043B ${o}:`,a)}console.log("\u2705 \u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u044B")}}catch(s){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",s),s}}createOptimizedImageUrl(t,s=800,e=85){return t.includes("supabase.co")?`${t}?width=${s}&quality=${e}&format=auto`:t}getOptimizedImageUrls(t,s){if(!t.imageUrls||t.imageUrls.length===0)return["/assets/default-product.jpg"];let e=s||window.innerWidth,o=800;return e<768?o=400:e<1200?o=600:o=1e3,t.imageUrls.map(a=>this.createOptimizedImageUrl(a,o,85))}async addProduct(t,s){console.log("\u2795 \u0414\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043D\u043E\u0432\u043E\u0433\u043E \u0442\u043E\u0432\u0430\u0440\u0430 \u0432 \u0440\u0435\u0436\u0438\u043C\u0435:",this.storageMode());let e=[];try{s&&s.length>0?(console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C ${s.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0441\u043E \u0441\u0436\u0430\u0442\u0438\u0435\u043C...`),e=await this.uploadProductImages(s)):e=this.cleanImageUrls(t.imageUrls||[]);let o=p(u({},t),{id:this.generateId(),imageUrls:e,createdAt:new Date,updatedAt:new Date});if(this.storageMode()==="local")return this.products.update(a=>[...a,o]),console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 localStorage:",o.name),o;{let a={name:o.name,description:o.description,price:o.price,categoryId:o.categoryId,categoryName:o.categoryName,imageUrls:o.imageUrls,stock:o.stock,features:o.features},r=await this.supabaseService.addProduct(a);if(r){let i=p(u({},o),{id:r.id});return this.products.update(n=>[...n,i]),console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D \u0432 Supabase:",i.name),i}else throw new Error("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0432 Supabase")}}catch(o){if(console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0434\u043E\u0431\u0430\u0432\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430:",o),e.length>0&&e.some(a=>this.isSupabaseStorageUrl(a)))try{await this.deleteProductImages(e)}catch(a){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0437\u0430\u0433\u0440\u0443\u0436\u0435\u043D\u043D\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",a)}throw o}}async updateProduct(t,s,e){console.log("\u270F\uFE0F \u041E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430 ID:",t);let o=s.imageUrls?[...s.imageUrls]:[];try{if(e&&e.length>0){console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0436\u0430\u0435\u043C ${e.length} \u043D\u043E\u0432\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0441\u043E \u0441\u0436\u0430\u0442\u0438\u0435\u043C...`);let a=await this.uploadProductImages(e);o=[...o,...a]}if(o.length>0&&(o=this.cleanImageUrls(o)),this.products.update(a=>a.map(r=>r.id==t?p(u(u({},r),s),{imageUrls:o.length>0?o:r.imageUrls,updatedAt:new Date,id:r.id}):r)),this.storageMode()==="supabase"){let a=p(u({},s),{imageUrls:o.length>0?o:s.imageUrls});await this.supabaseService.updateProduct(String(t),a)||console.warn("\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441 Supabase")}console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D")}catch(a){throw console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430:",a),a}}async deleteProduct(t){console.log("\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 \u0442\u043E\u0432\u0430\u0440\u0430 ID:",t);let s=this.getProductById(t);if(s&&this.storageMode()==="supabase"){let e=s.imageUrls.filter(o=>this.isSupabaseStorageUrl(o));if(e.length>0)try{await this.deleteProductImagesFromStorage(e)}catch(o){console.warn("\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u044F \u0438\u0437 Storage:",o)}}if(this.products.update(e=>e.filter(o=>o.id!=t)),this.storageMode()==="supabase")try{await this.supabaseService.deleteProduct(String(t))?console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0435\u043D \u0438\u0437 \u0442\u0430\u0431\u043B\u0438\u0446\u044B Supabase"):console.warn("\u26A0\uFE0F \u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0443\u0434\u0430\u043B\u0438\u0442\u044C \u0438\u0437 \u0442\u0430\u0431\u043B\u0438\u0446\u044B Supabase")}catch(e){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0438\u0437 Supabase:",e)}console.log("\u2705 \u0422\u043E\u0432\u0430\u0440 \u0443\u0434\u0430\u043B\u0435\u043D")}async deleteProductImagesFromStorage(t){try{console.log(`\u{1F5D1}\uFE0F \u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435 ${t.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0442\u043E\u0432\u0430\u0440\u0430 \u0438\u0437 Storage...`);let s=t.map(e=>this.extractFilePathFromUrl(e)).filter(e=>e!==null&&!e.includes("default-product.jpg"));if(s.length>0){console.log(`\u041D\u0430\u0439\u0434\u0435\u043D\u043E ${s.length} \u0444\u0430\u0439\u043B\u043E\u0432 \u0434\u043B\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F:`,s);let e=this.supabaseService.getClient(),{error:o}=await e.storage.from("product-images").remove(s);o?console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0438\u0437 Storage:",o):console.log(`\u2705 ${s.length} \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0443\u0434\u0430\u043B\u0435\u043D\u043E \u0438\u0437 Storage`)}else console.log("\u26A0\uFE0F \u041D\u0435\u0442 \u0444\u0430\u0439\u043B\u043E\u0432 \u0434\u043B\u044F \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0438\u0437 Storage")}catch(s){console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0443\u0434\u0430\u043B\u0435\u043D\u0438\u044F \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439:",s)}}isSupabaseStorageUrl(t){return t.includes("supabase.co")&&t.includes("/storage/v1/object/public/")}extractFilePathFromUrl(t){if(!t.includes("supabase.co")||!t.includes("/storage/v1/object/public/"))return null;try{let e=new URL(t).pathname.split("/"),o=e.indexOf("public");if(o!==-1&&o+1<e.length)return e.slice(o+1).join("/")}catch{console.warn("\u041D\u0435 \u0443\u0434\u0430\u043B\u043E\u0441\u044C \u0440\u0430\u0441\u043F\u0430\u0440\u0441\u0438\u0442\u044C URL:",t)}return null}async switchStorageMode(t){t!==this.storageMode()&&(console.log(`\u{1F504} \u041F\u0435\u0440\u0435\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0440\u0435\u0436\u0438\u043C\u0430 \u0441 ${this.storageMode()} \u043D\u0430 ${t}`),this.storageMode.set(t),localStorage.setItem("komfort_storage_mode",t),t==="local"?this.loadFromLocalStorage():await this.loadFromSupabase())}async testSupabase(){try{let t=await this.supabaseService.getProducts();return console.log("\u2705 Supabase \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D! \u0422\u043E\u0432\u0430\u0440\u043E\u0432 \u0432 \u0431\u0430\u0437\u0435:",t.length),!0}catch(t){return console.error("\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u044F \u043A Supabase:",t),!1}}async syncToSupabase(){console.log("\u{1F517} \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445 \u0441 Supabase...");let t=this.products(),s=0;for(let e of t)try{let o=e.imageUrls;o.filter(n=>!this.isSupabaseStorageUrl(n)&&!n.startsWith("data:image")).length>0&&(console.log(`\u{1F4E4} \u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0434\u043B\u044F ${e.name}...`),o=["/assets/default-product.jpg"]);let r={name:e.name,description:e.description,price:e.price,categoryId:e.categoryId,categoryName:e.categoryName,imageUrls:o,stock:e.stock,features:e.features};await this.supabaseService.addProduct(r)&&(s++,console.log(`\u2705 \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D: ${e.name}`))}catch(o){console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u0438 ${e.name}:`,o)}console.log(`\u{1F4CA} \u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0430\u0446\u0438\u044F \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D\u0430: ${s}/${t.length} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`)}clearProducts(){this.products.set([]),localStorage.removeItem(this.storageKey),console.log("\u{1F9F9} \u0412\u0441\u0435 \u0442\u043E\u0432\u0430\u0440\u044B \u043E\u0447\u0438\u0449\u0435\u043D\u044B")}resetToInitial(){this.products.set(this.getInitialProducts()),console.log("\u{1F504} \u0422\u043E\u0432\u0430\u0440\u044B \u0441\u0431\u0440\u043E\u0448\u0435\u043D\u044B \u043A \u043D\u0430\u0447\u0430\u043B\u044C\u043D\u044B\u043C")}async fixAllImageUrls(){console.log("\u{1F9F9} \u041E\u0447\u0438\u0441\u0442\u043A\u0430 \u0432\u0441\u0435\u0445 imageUrls...");let t=this.products().map(s=>p(u({},s),{imageUrls:this.cleanImageUrls(s.imageUrls||[])}));this.products.set(t),console.log("\u2705 \u0412\u0441\u0435 imageUrls \u043E\u0447\u0438\u0449\u0435\u043D\u044B"),this.storageMode()==="supabase"&&await this.syncToSupabase()}async fixBrokenProductImages(){console.log("\u{1F527} \u0418\u0441\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u0431\u0438\u0442\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u0442\u043E\u0432\u0430\u0440\u043E\u0432...");let t=this.products(),s=0;for(let e of t)try{if(e.imageUrls?.some(a=>a.includes("20101581_1.jpg")&&!a.startsWith("http"))){console.log(`\u{1F504} \u0418\u0441\u043F\u0440\u0430\u0432\u043B\u044F\u0435\u043C \u0442\u043E\u0432\u0430\u0440 "${e.name}"...`);let a=e.imageUrls.filter(r=>!(r.includes("20101581_1.jpg")&&!r.startsWith("http")));a.length===0&&a.push("/assets/default-product.jpg"),this.storageMode()==="supabase"&&await this.supabaseService.updateProduct(String(e.id),{imageUrls:a}),this.products.update(r=>r.map(i=>i.id===e.id?p(u({},i),{imageUrls:a}):i)),s++,console.log(`\u2705 \u0422\u043E\u0432\u0430\u0440 "${e.name}" \u0438\u0441\u043F\u0440\u0430\u0432\u043B\u0435\u043D`)}}catch(o){console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u0438\u0441\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u044F \u0442\u043E\u0432\u0430\u0440\u0430 "${e.name}":`,o)}console.log(`\u2705 \u0418\u0441\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u043E ${s} \u0442\u043E\u0432\u0430\u0440\u043E\u0432`)}async getImageStats(){let t=this.products(),s=0,e=0,o=0,a=0,r=0;t.forEach(n=>{n.imageUrls?.forEach(c=>{s++,this.isSupabaseStorageUrl(c)?e++:c.includes("default-product.jpg")?r++:c.startsWith("data:image")?a++:c.startsWith("/assets/")&&o++})});let i=parseFloat((e*.7*.5).toFixed(2));return{totalImages:s,supabaseImages:e,localImages:o,base64Images:a,defaultImages:r,estimatedSavingsMB:i}}async compressExistingImages(){console.log("\u{1F504} \u041F\u0430\u043A\u0435\u0442\u043D\u043E\u0435 \u0441\u0436\u0430\u0442\u0438\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439...");let t=this.products(),s=0;for(let e of t)try{let o=e.imageUrls?.filter(a=>this.isSupabaseStorageUrl(a)&&!a.includes("?width="))||[];o.length>0&&(console.log(`  \u0422\u043E\u0432\u0430\u0440 "${e.name}" \u0438\u043C\u0435\u0435\u0442 ${o.length} \u043D\u0435\u0441\u0436\u0430\u0442\u044B\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439`),s++)}catch(o){console.error(`\u274C \u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0438 \u0442\u043E\u0432\u0430\u0440\u0430 "${e.name}":`,o)}console.log(`\u2705 \u041F\u0440\u043E\u0430\u043D\u0430\u043B\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u043D\u043E ${s} \u0442\u043E\u0432\u0430\u0440\u043E\u0432 \u0434\u043B\u044F \u0441\u0436\u0430\u0442\u0438\u044F`),console.log("\u{1F4A1} \u0421\u043E\u0432\u0435\u0442: \u0414\u043B\u044F \u0441\u0436\u0430\u0442\u0438\u044F \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u044E\u0449\u0438\u0445 \u0438\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0439 \u043F\u0435\u0440\u0435\u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u0435 \u0438\u0445 \u0447\u0435\u0440\u0435\u0437 \u0444\u043E\u0440\u043C\u0443 \u0440\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u044F")}static \u0275fac=function(s){return new(s||y)};static \u0275prov=U({token:y,factory:y.\u0275fac,providedIn:"root"})};export{M as a};
